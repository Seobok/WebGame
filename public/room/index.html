<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.socket.io/4.5.3/socket.io.min.js" integrity="sha384-WPFUvHkB1aHA5TDSZi6xtDgkF0wXJcIIxXhC6h8OT8EH3fC5PWro5pWJ1THjcfEi" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script>
            var currentCategory = 'notChoice';
            var currentTime = 0;
            var curPlayer;
            var word;
            var draw_timer = null;
            var remainTime;
            var score = 0;
            var ready = false;
            var allReady = true;

            const changeCategory = (target) => {       //카테고리 고르는 리스트 리스너
                currentCategory = target.value;
                socket.emit('changeCategory', currentCategory)
            }

            const changeTimer = (target) => {
                currentTime = parseInt(target.value);
                socket.emit('changeTimer', currentTime)
            }

            function sendCSV(data) {                //CSV파일 서버로 전달
                socket.emit('sendCSV', data)
            }

            function openPop() {
                document.getElementById("popup_layer").style.display = "block";
            }

            function closePop() {
                document.getElementById("popup_layer").style.display = "none";
            }
            window.onload = function() {
                //<!-- 서버 관련 함수 -->
                params = (new URL(document.location)).searchParams
                id = params.get('roomId')
                
                socket = io('localhost:52273',{
                    query: {
                        roomId : id,
                        roomName : params.get('roomName'),
                        category : params.get('category'),
                        timeout : params.get('timeout')
                    }
                });

                //<!--CSV불러오기-->
                $.ajax({
                    url: 'wordList.CSV',
                    dataType: 'text',
                }).done(sendCSV);

                //<!-- 그림판 관련 변수 및 함수 선언 -->
                var canvas, context;
                var draw_color, draw_width, is_drawing;
                var restore_array, index;
                var oldPointX, oldPointY, newPointX, newPointY;
                var background_color ="whitesmoke";
                var lastCanvas;

                function start(event) {
                    is_drawing = true;
                    context.beginPath();
                    oldPointX = event.clientX - canvas.offsetLeft;
                    oldPointY = event.clientY - canvas.offsetTop;
                    context.moveTo(oldPointX, oldPointY);

                    event.preventDefault();
                }

                function draw(event) {
                    if(is_drawing){
                        newPointX = event.clientX - canvas.offsetLeft;
                        newPointY = event.clientY - canvas.offsetTop;
                        context.lineTo(newPointX, newPointY);
                        context.strokeStyle = draw_color;
                        context.lineWidth = draw_width;
                        context.lineCap = "round";
                        context.lineJoin = "round";
                        context.stroke();

                        socket.emit('line', {
                            x1 : oldPointX,
                            y1 : oldPointY,
                            x2 : newPointX,
                            y2 : newPointY,
                            color : draw_color,
                            width : draw_width
                        })

                        oldPointX = newPointX;
                        oldPointY = newPointY;
                    }
                }

                function stop(event) {
                    if(is_drawing) {
                        context.stroke();
                        context.closePath();
                        is_drawing = false;
                        restore_array.push(context.getImageData(0,0,canvas.width, canvas.height));
                        index++;
                        socket.emit('stop')
                    }
                    event.preventDefault();
                }

                function clear_canvas() {
                    context.fillStyle = background_color;
                    context.clearRect(0,0,canvas.width, canvas.height);
                    context.fillRect(0,0,canvas.width, canvas.height);

                    restore_array.push(context.getImageData(0,0,canvas.width, canvas.height));
                    index++;
                }

                function undo_last() {
                    if(index <= 0) {
                        clear_canvas();
                    } else {
                        index--;
                        restore_array.pop();
                        context.putImageData(restore_array[index], 0, 0);
                    }
                }

                function drawTimer(time, obj){
                    var min, sec;

                    draw_timer = setInterval(function(){
                        this.remainTime = time;
                        time--;

                        min = Math.floor(time/60);
                        sec = time%60;
                        min = min%60;

                        var tm = min;
                        var ts = sec;

                        // 한자리일 경우 처리
                        if(tm < 10){
                            tm = "0" + min;
                        }
                        if(ts < 10){
                            ts = "0" + sec;
                        }

                        // 함수 호출 당시 받은 object의 html 교체
                        obj.innerHTML =  "남은 시간 : " + tm + ":" + ts;

                        if(ts == 0) 
                        {
                            clearInterval(draw_timer)
                            draw_timer = null;

                            obj.innerHTML =  '';
                            alert('시간 초과!');
                        }
                    }
                , 1000);
                }

                function choiceWordTimer(time, obj, list, wordTimer){
                    var min, sec;

                    var timer = setInterval(function(){
                        time--;

                        min = Math.floor(time/60);
                        sec = time%60;
                        min = min%60;

                        var tm = min;
                        var ts = sec;
        
                        // 한자리일 경우 처리
                        if(tm < 10){
                            tm = "0" + min;
                        }
                        if(ts < 10){
                            ts = "0" + sec;
                        }

                        // 함수 호출 당시 받은 object의 html 교체
                        obj.innerHTML =  "남은 시간 : " + tm + ":" + ts;

                        if(word) 
                        {
                            setTimeout(function(){
                                clearInterval(timer)
                            }, 0)
                            obj.innerHTML =  '';
                            socket.emit('wordChoiced')
                        }

                        if(ts == 0) 
                        {
                            setTimeout(function(){
                                clearInterval(timer)
                            }, 0)                            
                            obj.innerHTML =  '';

                            randomNumber = Math.floor(Math.random() * list.length);
                            word = list[randomNumber];
                            console.log(word);
                            socket.emit('choicedWord', word);
                            socket.emit('wordChoiced')
                        }
                    }
                , 1000);
                }

                //<!-- 여기 까지 -->

                socket.emit('roomMemberList', id)

                socket.on('over', () => {
                    window.location.replace('/overcapacity.html')
                })

                socket.on('userCount', (count, nick) => {
                    var userCounter = document.getElementById('usercount');
                    var nicknames = document.getElementsByClassName('nicknames')
                    var output = '';
                    userCounter.innerHTML = count + " / 4 ";
                    for(let i =0; i<nick.length;i++) {
                        nicknames[i].innerHTML = nick[i] 
                        console.log(this.nickname,  nick[i])
                        if(this.nickname == nick[i])
                        {
                            nicknames[i].style.border = "5px solid red";
                        }
                    }                                        
                })

                socket.on('userNick', (nickname) => {
                    this.nickname = nickname
                })

                socket.on('checkReady', (Ready) => {
                    this.allReady = Ready
                    console.log(allReady)
                })

                socket.on('findRoomMaster', (name) => {
                    this.roomMaster = false
                    if(this.nickname == name)
                        roomMaster = true;

                    var showButton = document.getElementById('startGame')

                    if(roomMaster) {
                        var newRoomMasterChoiceList = document.getElementById('newRoomMasterChoiceList')
                        newRoomMasterChoiceList.innerHTML = `
                        <td>
                            <form id = 'nonVisibleCategory'>
                                <p>
                                    <select onchange="changeCategory(this)" id="category">
                                        <option value="korean">한글</option>
                                        <option value="pen">학용품</option>
                                        <option value="instrument">악기</option>
                                        <option value="food">음식</option>
                                        <option value="electronics">전자제품</option>
                                        <option value="sport">운동</option>
                                    </select>
                                </p>
                            </form>
                        </td>
                        <td>
                            <form id = 'nonVisibleTimeout'>
                                <p>
                                    <select onchange="changeTimer(this)" id="timeout">
                                        <option value="30">30초</option>
                                        <option value="60">1분</option>
                                        <option value="90">1분30초</option>
                                        <option value="120">2분</option>
                                    </select>
                                </p>
                            </form>
                        </td>`

                        socket.emit('newRoomMasterChangeList')

                        showButton.innerHTML = '게임 시작'
                        showButton.onclick  = function() {
                            if((currentCategory != 'notChoice') && (currentTime != 0) && (allReady == true)) 
                            {
                                socket.emit('gameStart')                                   
                            }
                        }
                    }
                    else
                    {
                        showButton.innerHTML = '준 비'
                        showButton.onclick = function() {
                            if(ready == false)
                            {
                                ready = true;
                            }
                            else
                            {
                                ready = false;
                            }
                            socket.emit('changeReady', ready);
                        }
                    }                    
                })

                socket.on('changeCategoryTimeoutList', (_category, _timeout) => {
                    var categories = document.getElementById("category").getElementsByTagName('option');
                    for(let i = 0;i < categories.length; i++)
                    {
                        if(categories[i].value == _category)
                        {
                            categories[i].selected = 'selected'
                        }
                    }
                    var timeouts = document.getElementById("timeout").getElementsByTagName('option');
                    for(let i = 0;i<timeouts.length;i++)
                    {
                        if(timeouts[i].value == _timeout)
                        {
                            timeouts[i].selected = 'selected'
                        }
                    }
                })

                socket.on('changeCategoryTimeout', (_category, _timeout) => {
                    //TODO 방장 나갈때 처리
                    var nonVisibleCategory = document.getElementById('nonVisibleCategory');
                    var nonVisibleTimeout = document.getElementById('nonVisibleTimeout');                                          
                    nonVisibleCategory.innerHTML = _category;                        
                    nonVisibleTimeout.innerHTML = _timeout;
                              
                })

                socket.on('roomListClear', () => {
                    var readyArray = document.getElementsByClassName("readyStatus")
                    for(array of readyArray)
                    {
                        array.innerHTML = ""
                    }

                    var nicknames = document.getElementsByClassName('nicknames')
                    for(nickA of nicknames)
                    {
                        nickA.innerHTML = ""
                        nickA.style.border = "1px none"
                    }
                })

                socket.on('stop', () => {
                    index++;
                    restore_array.push(context.getImageData(0,0,canvas.width, canvas.height));
                })

                socket.on('undo', () =>{
                    undo_last();
                })

                socket.on('clear', () =>{
                    clear_canvas();
                })

                socket.on('wordList', (data, time) => {
                    currentCategory = data;
                    currentTime = time
                })

                socket.on('setBrowser', (currentPlayer) => {
                    if(currentCategory != 'notChoice')
                    {
                        socket.emit('wordCategory', currentCategory, currentTime);
                    }

                    document.body.innerHTML = `
                    <canvas id = 'canvas'>
                    </canvas>
                    <div id = 'tool'>
                        <table>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'undo'></div>
                            </td>
                            <td>
                                <div class = 'clear'></div>
                            </td>
                        </table>
                    </div>
                    <button id='nextPlayer'>다음사람</button>
                    <div id='msgs' type = 'none'>
                    </div>
                    <form id = 'msgform'>
                        <input id ='msginput' autocomplete = 'off' type='text'>
                        <button type = 'submit'>입력</button>    
                    </form>
                    <div id ='timer'></div>
                    <div class = "popup_layer" id="popup_layer" style="display: none;">
                        <div class="popup_box">
                            <center>
                                <table style="width:900px; padding: 0px; background-color: white; margin: 0px;">
                                    <tr>
                                        <td>
                                            <button class = 'word' style = "font-size: 70px"></button>
                                        </td>
                                        <td>
                                            <button class = 'word' style = "font-size: 70px"></button>
                                        </td>
                                        <td>
                                            <button class = 'word' style = "font-size: 70px"></button>
                                        </td>
                                    </tr>
                                </table>
                            </center>
                        </div>
                    </div>`

                    var startbtn = document.getElementById('nextPlayer')
                    startbtn.onclick = function() {
                        socket.emit('nextPlayer')
                    }
                    //<!--채팅-->
                    var msgform = document.getElementById('msgform');

                    msgform.onsubmit = (e) => {
                        e.preventDefault();
                        var msginput = document.getElementById('msginput');

                        socket.emit('message', msginput.value, remainTime);

                        msginput.value = "";
                    };
                    //<!--채팅 여기까지-->
                    
                    palettes = document.querySelectorAll(".palette")

                    tool = document.getElementById('tool');
                    
                    undo = document.querySelector('.undo')
                    undo.onclick = function() {
                            undo_last();
                            socket.emit('undo')
                        }

                    clear = document.querySelector('.clear')
                    clear.onclick = function() {
                            clear_canvas();
                            socket.emit('clear')
                        }

                    for(let i = 0; i < 11; i++) {
                        palettes[i].onclick = function() {
                            draw_color = palettes[i].style.backgroundColor
                        }
                    }

                    canvas = document.getElementById('canvas')
                    canvas.width = 800
                    canvas.height = 600

                    context = canvas.getContext('2d')
                    context.fillStyle = background_color
                    context.fillRect(0, 0, canvas.width,canvas.height);

                    draw_color="black";
                    draw_width = "2";
                    is_drawing = false;

                    restore_array = [];
                    index = -1;
                    
                   if(this.roomMaster)
                   {
                        socket.emit('nextPlayer')
                   }
                })

                socket.on('changeReadyImage', (index, bool) => {
                    var readyArray = document.getElementsByClassName("readyStatus")
                    if(bool)
                    {
                        readyArray[index-1].innerHTML = "ready";
                    }
                    else
                    {
                        readyArray[index-1].innerHTML = "not ready";
                    }
                })

                socket.on('requireMorePlayer', () => {
                    alert("혼자서는 플레이할 수 없습니다!");
                })

                socket.on('message', (msg) => {
                    var messageList = document.getElementById('msgs');
                    var messageTag = document.createElement("p");
                    messageTag.innerText = msg;
                    messageList.appendChild(messageTag);
                });

                socket.on('calScore', (curScore) => {
                    this.score = curScore;
                    console.log(curScore)
                })

                var waitingMsgForm = document.getElementById('waitingMsgForm');
                waitingMsgForm.onsubmit = (e) => {
                    e.preventDefault();
                    var msginput = document.getElementById('waitingMsgInput');

                    socket.emit('waitingroomMessage', msginput.value);

                    msginput.value = "";
                };

                socket.on('waitingroomMessage', (msg) => {
                    var messageList = document.getElementById('waitingMsgs');
                    var messageTag = document.createElement("p");
                    messageTag.innerText = msg;
                    messageList.appendChild(messageTag);
                });

                socket.on('setWords', (list) => {
                    var wordClass = document.getElementsByClassName('word');                    

                    word = undefined;

                    if(this.nickname == curPlayer)
                    {
                        for(let i =0; i<wordClass.length; i++)
                        {
                            wordClass[i].innerHTML = list[i]
                        }

                        openPop();

                        var timer = document.getElementById('timer');
                        choiceWordTimer(10, timer, list);
                    }                        
                    
                    for(let i =0; i<wordClass.length; i++)
                    {
                        wordClass[i].onsubmit= function() {

                        }
                        wordClass[i].onclick = function() {
                            word = wordClass[i].innerText;
                            console.log(word);
                            socket.emit('choicedWord', word);
                            closePop()
                            drawTimer(currentTime, timer);
                        }
                    }
                })

                socket.on('choicedWord2', (choicedWord) => {
                    word = choicedWord;
                    console.log(word)
                })

                socket.on('wordChoiced2', () => {
                    var timer = document.getElementById('timer');
                    drawTimer(currentTime, timer)
                })

                socket.on('next', (previousPlayer, currentPlayer) => {
                    socket.emit('clear')
                    if(draw_timer != null)
                    {
                        clearInterval(draw_timer)
                        draw_timer = null;
                    }

                    var timer = document.getElementById('timer');
                    timer.innerHTML =''

                    curPlayer = currentPlayer

                    if(this.nickname == previousPlayer)
                    {
                        canvas.removeEventListener("touchstart", start)
                        canvas.removeEventListener("touchmove", draw);
                        canvas.removeEventListener("mousedown", start)
                        canvas.removeEventListener("mousemove", draw);

                        canvas.removeEventListener("touchend", stop);
                        canvas.removeEventListener("mouseup", stop);
                        canvas.removeEventListener("mouseout", stop);

                        undo.setAttribute("style", "height: 0px; width: 0px");
                        clear.setAttribute("style", "height: 0px; width: 0px");
                        tool.setAttribute("style", "height: 0px; width: 0px");

                        palettes[0].setAttribute("style", "height: 0px; width: 0px;")   
                        palettes[1].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[2].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[3].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[4].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[5].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[6].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[7].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[8].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[9].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[10].setAttribute("style", "height: 0px; width: 0px;")
                    }

                    if(this.nickname == currentPlayer)
                    {
                        socket.emit('getWords')

                        canvas.addEventListener("touchstart", start, false);
                        canvas.addEventListener("touchmove", draw, false);
                        canvas.addEventListener("mousedown", start, false)
                        canvas.addEventListener("mousemove", draw, false);

                        canvas.addEventListener("touchend", stop, false);
                        canvas.addEventListener("mouseup", stop, false);
                        canvas.addEventListener("mouseout", stop, false);

                        undo.setAttribute("style", "height: 50px; width: 50px; background-image: url('undo.png'); background-size: cover;")
                        clear.setAttribute("style", "height: 50px; width: 50px; background-image: url('eraser.png'); background-size: cover;")
                        tool.setAttribute("style", "background-color: darkgray; height: 50px; width: 770px; padding: 15px;")
                        
                        palettes[0].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: red;")
                        palettes[1].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: orange;")
                        palettes[2].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: yellow;")
                        palettes[3].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: greenyellow;")
                        palettes[4].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: green;")
                        palettes[5].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: lightblue;")
                        palettes[6].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: blue;")
                        palettes[7].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: purple;")
                        palettes[8].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: white;")
                        palettes[9].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: grey;")
                        palettes[10].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: black;")
                    }
                })

                socket.on('line', (data) => {
                    context.beginPath();
                    context.lineWidth = data.width;
                    context.strokeStyle = data.color;
                    context.moveTo(data.x1, data.y1);
                    context.lineTo(data.x2, data.y2);
                    context.stroke();
                })
            }            
        </script>
        <style>
            .popup_box{
                position: relative;
                top:50%;
                left:50%; 
                overflow: auto; 
                height: 220px; 
                width:1200px;
                transform:translate(-50%, -120%);
                z-index:1002;
                box-sizing:border-box;
                background:#fff;
                box-shadow: 2px 5px 10px 0px rgba(0,0,0,0.35);
                -webkit-box-shadow: 2px 5px 10px 0px rgba(0,0,0,0.35);
                -moz-box-shadow: 2px 5px 10px 0px rgba(0,0,0,0.35);
            }
            .popup_box tr{
                height: 200px;
                padding: 0px;
                margin: 0px;
            }
            .popup_box td{
                width: inherit;
                padding: 0px;
                margin: 0px;
            }

            .word{
                height: 100px;
                width: 300px;
                padding: 0px;
                margin: 0px;
            }
        </style>
    </head>
    <body>
        <div><img src="title.png" style="width: 200px; height: 50px;"></div>
        <center>
            <table style="width:1040px; padding-top: 20px; padding-left: 20px; padding-right: 20px; background-color: white; margin-top: 40px; padding-bottom: 20px;">
                <tr>
                    <td style="width: 1px;">
                        <table style="width: 680px; border-color:black; border-style:solid; vertical-align:middle;">
                            <tr height = "50px" style="background-color: white;">
                                <td width = "30px"><img src="crown.png" style="width: 30px; height: 30px"></td>
                                <td class = "nicknames" style="font-size:20px;"></td>
                                <td style="text-align:right;"></td>
                            </tr>
                            <tr height = "50px" style="background-color: white;">
                                <td></td>
                                <td class = "nicknames" style="font-size:20px;"></td>
                                <td class="readyStatus" style="text-align:right;"></td>
                            </tr>
                            <tr height = "50px" style="background-color: white;">
                                <td></td>
                                <td class = "nicknames" style="font-size:20px;"></td>
                                <td class="readyStatus" style="text-align:right;"></td>
                            </tr>
                            <tr height = "50px" style="background-color: white;">
                                <td></td>
                                <td class = "nicknames" style="font-size:20px;"></td>
                                <td class="readyStatus" style="text-align:right;"></td>
                            </tr>
                        </table>
                    </td>
                    <td style="background-color:white; width: 20px;">
                        
                    </td>
                    <td>
                        <table style="border-color:black; border-style:solid; height: 215px; width: 300px; text-align: center;">
                            <tr>
                                <td colspan="2" id = 'usercount' style="text-align: right; vertical-align: top; height: 20px;"></td>
                            </tr>
                            <tr style="vertical-align:bottom;">
                                <td>카테고리</td>
                                <td>시간제한</td>
                            </tr>
                            <tr style="vertical-align:top;" id = "newRoomMasterChoiceList">
                                <td>
                                    <form id = 'nonVisibleCategory'>
                                        <p>
                                            <select onchange="changeCategory(this)" id="category">
                                                <option value="korean">한글</option>
                                                <option value="pen">학용품</option>
                                                <option value="instrument">악기</option>
                                                <option value="food">음식</option>
                                                <option value="electronics">전자제품</option>
                                                <option value="sport">운동</option>
                                            </select>
                                        </p>
                                    </form>
                                </td>
                                <td>
                                    <form id = 'nonVisibleTimeout'>
                                        <p>
                                            <select onchange="changeTimer(this)" id="timeout">
                                                <option value="30">30초</option>
                                                <option value="60">1분</option>
                                                <option value="90">1분30초</option>
                                                <option value="120">2분</option>
                                            </select>
                                        </p>
                                    </form>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td style="height: 80px;"></td>
                    <td></td>
                    <td style="text-align:center; vertical-align:middle; border-style: solid;"><button id = 'startGame'></button></td>
                </tr>
                <tr style="height: 400px;">
                    <td colspan="3" style="border-style: solid; vertical-align: top;"><div id = 'waitingMsgs' style = "overflow: auto; width: inherit; height: 380px;"></div></td>
                </tr>
                <tr style = "height: 15px;">
                    <td colspan="3" style="height: 20px; text-align:center; vertical-align:middle; border-style: solid;">
                        <form id = 'waitingMsgForm'>
                            <input id ='waitingMsgInput' autocomplete = 'off' type='text'>
                            <button type = 'submit'>입력</button>    
                        </form>
                    </td>
                </tr>
            </table>
        </center>
    </body>
</html>