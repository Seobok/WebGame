<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.socket.io/4.5.3/socket.io.min.js" integrity="sha384-WPFUvHkB1aHA5TDSZi6xtDgkF0wXJcIIxXhC6h8OT8EH3fC5PWro5pWJ1THjcfEi" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script>
            var currentCategory = 'notChoice';

            var korean = new Array();
            var pen = new Array();

            const changeValue = (target) => {
                currentCategory = target.value;
            }

            function parseCSV(data) {
                var allRows = data.split(/\r?\n|\r/);
                for (var singleRow = 0; singleRow < allRows.length; singleRow++) {
                    var rowCells = allRows[singleRow].split(',');
                    if(Math.floor(rowCells[0]/1000) == 1)
                    {
                        korean.push(rowCells[1])
                    }
                    else if(Math.floor(rowCells[0]/1000) == 2)
                    {
                        pen.push(rowCells[1])
                    }
                }

                console.log(korean)
                console.log(pen)
            }

            window.onload = function() {
                //<!-- 서버 관련 함수 -->
                params = (new URL(document.location)).searchParams
                id = params.get('roomId')
                
                socket = io('localhost:52273',{
                    query: {
                        roomId : id
                    }
                });

                //<!--CSV파싱-->
                $.ajax({
                    url: 'wordList.CSV',
                    dataType: 'text',
                }).done(parseCSV);

                //<!-- 그림판 관련 변수 및 함수 선언 -->
                var canvas, context;
                var draw_color, draw_width, is_drawing;
                var restore_array, index;
                var oldPointX, oldPointY, newPointX, newPointY;
                var background_color ="whitesmoke";
                var lastCanvas;

                function start(event) {
                    is_drawing = true;
                    context.beginPath();
                    oldPointX = event.clientX - canvas.offsetLeft;
                    oldPointY = event.clientY - canvas.offsetTop;
                    context.moveTo(oldPointX, oldPointY);

                    event.preventDefault();
                }

                function draw(event) {
                    if(is_drawing){
                        newPointX = event.clientX - canvas.offsetLeft;
                        newPointY = event.clientY - canvas.offsetTop;
                        context.lineTo(newPointX, newPointY);
                        context.strokeStyle = draw_color;
                        context.lineWidth = draw_width;
                        context.lineCap = "round";
                        context.lineJoin = "round";
                        context.stroke();

                        socket.emit('line', {
                            x1 : oldPointX,
                            y1 : oldPointY,
                            x2 : newPointX,
                            y2 : newPointY,
                            color : draw_color,
                            width : draw_width
                        })

                        oldPointX = newPointX;
                        oldPointY = newPointY;
                    }
                }

                function stop(event) {
                    if(is_drawing) {
                        context.stroke();
                        context.closePath();
                        is_drawing = false;
                        restore_array.push(context.getImageData(0,0,canvas.width, canvas.height));
                        index++;
                        socket.emit('stop')
                    }
                    event.preventDefault();
                }

                function clear_canvas() {
                    context.fillStyle = background_color;
                    context.clearRect(0,0,canvas.width, canvas.height);
                    context.fillRect(0,0,canvas.width, canvas.height);

                    restore_array.push(context.getImageData(0,0,canvas.width, canvas.height));
                    index++;
                }

                function undo_last() {
                    if(index <= 0) {
                        clear_canvas();
                    } else {
                        index--;
                        restore_array.pop();
                        context.putImageData(restore_array[index], 0, 0);
                    }
                }
                //<!-- 여기 까지 -->

                socket.emit('roomMemberList', id)

                socket.on('over', () => {
                    console.log('인원초과')
                    window.location.replace('/overcapacity.html')
                })

                socket.on('userCount', (count, nick) => {
                    if(document.getElementById('usercount'))
                    {
                        var userCounter = document.getElementById('usercount');
                        var userList = document.getElementById('userlist');
                        var output = '';
                        userCounter.innerHTML = "현재 " + count + "명이 서버에 접속해있습니다." + '<br>';
                        for(let item of nick) {
                            output += item + '<br>'
                        }
                        userList.innerHTML = output
                    }                    
                })

                socket.on('userNick', (nickname) => {
                    this.nickname = nickname
                    var userNickname = document.getElementById('nickname');
                    userNickname.innerHTML = "현재 당신의 닉네임 : " + this.nickname;
                })

                socket.on('findRoomMaster', (name) => {
                    this.roomMaster = false
                    if(this.nickname == name)
                        roomMaster = true;
                    if(document.getElementById('roommaster'))
                    {
                        var chkroomMaster = document.getElementById('roommaster');
                        var choiceWord = document.getElementById('choiceWord')

                        chkroomMaster.innerHTML = "방장? : " + roomMaster;

                        if(roomMaster) {
                            var gamestartbtntext = document.getElementById('gamestartbtn');
                            gamestartbtntext.innerHTML = "<button id='startbtn'>게임시작</button>"
                            choiceWord.innerHTML = `
                            <form>
                                <p>
                                    <select name = 'category' onchange="changeValue(this)">
                                        <option selected>리스트 목록</option>
                                        <option value="korean">한글</option>
                                        <option value="pen">학용품</option>
                                    </select>
                                </p>
                            </form> `
                            var startbtn = document.getElementById('startbtn')
                            startbtn.onclick = function() {
                                if(currentCategory != 'notChoice')
                                {
                                    socket.emit('gameStart')
                                }                            
                            }
                        }
                    }
                })

                socket.on('stop', () => {
                    index++;
                    restore_array.push(context.getImageData(0,0,canvas.width, canvas.height));
                })

                socket.on('undo', () =>{
                    undo_last();
                })

                socket.on('clear', () =>{
                    clear_canvas();
                })

                socket.on('setBrowser', (currentPlayer) => {
                    document.body.innerHTML = `
                    <canvas id = 'canvas'>
                    </canvas>
                    <div id = 'tool'>
                        <table>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'palette'></div>
                            </td>
                            <td>
                                <div class = 'undo'></div>
                            </td>
                            <td>
                                <div class = 'clear'></div>
                            </td>
                        </table>
                    </div>
                    <button id='nextPlayer'>다음사람</button>
                    <ul id='msgs' type = 'none'>
                    </ul>
                    <form id = 'msgform'>
                        <input id ='msginput' autocomplete = 'off' type='text'>
                        <button type = 'submit'>입력</button>    
                    </form>`
                    var startbtn = document.getElementById('nextPlayer')
                    startbtn.onclick = function() {
                        socket.emit('nextPlayer')
                    }
                    //<!--채팅-->
                    var msgform = document.getElementById('msgform');

                    socket.on('message', (msg) => {
                        var messageList = document.getElementById('msgs');
                        var messageTag = document.createElement("li");
                        messageTag.innerText = msg;
                        messageList.appendChild(messageTag);
                    });

                    msgform.onsubmit = (e) => {
                        e.preventDefault();
                        var msginput = document.getElementById('msginput');

                        socket.emit('message', msginput.value);

                        msginput.value = "";
                    };
                    //<!--채팅 여기까지-->

                    if(currentCategory != 'notChoice')
                    {
                        socket.emit('wordCategory', currentCategory);
                    }

                    socket.on('wordList', (data) => {
                        currentCategory = data;
                    })
                    
                    palettes = document.querySelectorAll(".palette")

                    tool = document.getElementById('tool');
                    
                    undo = document.querySelector('.undo')
                    undo.onclick = function() {
                            undo_last();
                            socket.emit('undo')
                        }

                    clear = document.querySelector('.clear')
                    clear.onclick = function() {
                            clear_canvas();
                            socket.emit('clear')
                        }

                    for(let i = 0; i < 11; i++) {
                        palettes[i].onclick = function() {
                            draw_color = palettes[i].style.backgroundColor
                        }
                    }

                    canvas = document.getElementById('canvas')
                    canvas.width = 800
                    canvas.height = 600

                    context = canvas.getContext('2d')
                    context.fillStyle = background_color
                    context.fillRect(0, 0, canvas.width,canvas.height);

                    draw_color="black";
                    draw_width = "2";
                    is_drawing = false;

                    restore_array = [];
                    index = -1;

                    if(this.nickname == currentPlayer)
                    {
                        canvas.addEventListener("touchstart", start, false);
                        canvas.addEventListener("touchmove", draw, false);
                        canvas.addEventListener("mousedown", start, false)
                        canvas.addEventListener("mousemove", draw, false);

                        canvas.addEventListener("touchend", stop, false);
                        canvas.addEventListener("mouseup", stop, false);
                        canvas.addEventListener("mouseout", stop, false);

                        undo.setAttribute("style", "height: 50px; width: 50px; background-image: url('undo.png'); background-size: cover;")
                        clear.setAttribute("style", "height: 50px; width: 50px; background-image: url('eraser.png'); background-size: cover;")
                        tool.setAttribute("style", "background-color: darkgray; height: 50px; width: 770px; padding: 15px;")
                        
                        palettes[0].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: red;")
                        palettes[1].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: orange;")
                        palettes[2].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: yellow;")
                        palettes[3].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: greenyellow;")
                        palettes[4].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: green;")
                        palettes[5].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: lightblue;")
                        palettes[6].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: blue;")
                        palettes[7].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: purple;")
                        palettes[8].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: white;")
                        palettes[9].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: grey;")
                        palettes[10].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: black;")
                    }
                })

                socket.on('next', (previousPlayer, currnetPlayer) => {
                    socket.emit('clear')

                    if(this.nickname == previousPlayer)
                    {
                        canvas.removeEventListener("touchstart", start)
                        canvas.removeEventListener("touchmove", draw);
                        canvas.removeEventListener("mousedown", start)
                        canvas.removeEventListener("mousemove", draw);

                        canvas.removeEventListener("touchend", stop);
                        canvas.removeEventListener("mouseup", stop);
                        canvas.removeEventListener("mouseout", stop);

                        undo.setAttribute("style", "height: 0px; width: 0px");
                        clear.setAttribute("style", "height: 0px; width: 0px");
                        tool.setAttribute("style", "height: 0px; width: 0px");

                        palettes[0].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[1].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[2].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[3].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[4].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[5].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[6].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[7].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[8].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[9].setAttribute("style", "height: 0px; width: 0px;")
                        palettes[10].setAttribute("style", "height: 0px; width: 0px;")
                    }

                    if(this.nickname == currnetPlayer)
                    {
                        canvas.addEventListener("touchstart", start, false);
                        canvas.addEventListener("touchmove", draw, false);
                        canvas.addEventListener("mousedown", start, false)
                        canvas.addEventListener("mousemove", draw, false);

                        canvas.addEventListener("touchend", stop, false);
                        canvas.addEventListener("mouseup", stop, false);
                        canvas.addEventListener("mouseout", stop, false);

                        undo.setAttribute("style", "height: 50px; width: 50px; background-image: url('undo.png'); background-size: cover;")
                        clear.setAttribute("style", "height: 50px; width: 50px; background-image: url('eraser.png'); background-size: cover;")
                        tool.setAttribute("style", "background-color: darkgray; height: 50px; width: 770px; padding: 15px;")
                        
                        palettes[0].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: red;")
                        palettes[1].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: orange;")
                        palettes[2].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: yellow;")
                        palettes[3].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: greenyellow;")
                        palettes[4].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: green;")
                        palettes[5].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: lightblue;")
                        palettes[6].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: blue;")
                        palettes[7].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: purple;")
                        palettes[8].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: white;")
                        palettes[9].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: grey;")
                        palettes[10].setAttribute("style", "height: 50px; width: 50px; border-radius: 50%; background-color: black;")
                    }
                })

                socket.on('line', (data) => {
                    context.beginPath();
                    context.lineWidth = data.width;
                    context.strokeStyle = data.color;
                    context.moveTo(data.x1, data.y1);
                    context.lineTo(data.x2, data.y2);
                    context.stroke();
                })
            }            
        </script>
    </head>
    <body background = "background.png">
        <ul id = "waiting" type = "none">
            <li id = "usercount"></li>
            <li id = "nickname"></li>
            <li id = "userlist"></li>
            <li id = "roommaster"></li>
            <li id = 'choiceWord'></li>
            <li id = "gamestartbtn"></li>
        </ul>        
    </body>
</html>